theory Mastercard_DDA_NoPIN_High begin

// Function signature and definition of the equational theory E

builtins: multiset, xor
functions: DES3/2, MAC/5, NEq/2, adec/2, aenc/2, f/2, fst/1, h/1, p8/1,
           pair/2, pk/1, sdec/2, senc/2, sign/2, snd/1, true/0, verify/3
equations:
    adec(aenc(x.1, pk(x.2)), x.2) = x.1,
    fst(<x.1, x.2>) = x.1,
    sdec(senc(x.1, x.2), x.2) = x.1,
    snd(<x.1, x.2>) = x.2,
    verify(sign(x.1, x.2), x.1, pk(x.2)) = true



rule (modulo E) Terminal_Bank_Network:
   [ Send( S, R, channelID, msg ) ] --> [ Recv( S, R, channelID, msg ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_Amount_Low:
   [ ] --[ Once( <$amount, 'Amount'> ) ]-> [ !Value( $amount, 'Low' ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_Amount_High:
   [ ] --[ Once( <$amount, 'Amount'> ) ]-> [ !Value( $amount, 'High' ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_ATC:
   [ Fr( ~ATC ) ] --> [ !ATC( ~ATC ), Out( ~ATC ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Generate_SDAD_Format_Visa:
   [ ] --> [ !SDADFormat( '05', 'TC' ), !SDADFormat( '95', 'ARQC' ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Create_CA:
   [ Fr( ~privkCA ) ]
  --[ Once( $CA ), Role( $CA, 'CA' ) ]->
   [
   !LtkCA( $CA, ~privkCA ),
   !CertCA( $CA,
            <<'01', $CA, pk(~privkCA), $CA>, 
             sign(<'01', $CA, pk(~privkCA), $CA>, ~privkCA)>
   ),
   Out( pk(~privkCA) )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Create_Bank:
   [ Fr( ~privkBank ), !LtkCA( $CA, ~privkCA ) ]
  --[ Once( $Bank ), Role( $Bank, 'Bank' ) ]->
   [
   !LtkBank( $Bank, ~privkBank ),
   !CertBank( $Bank,
              <<'02', $Bank, pk(~privkBank), $CA>, 
               sign(<'02', $Bank, pk(~privkBank), $CA>, ~privkCA)>
   ),
   !IssuingCA( $Bank, $CA ), Out( pk(~privkBank) )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Compromise_CA:
   [ !LtkCA( $CA, ~privkCA ) ] --[ Compromise( $CA ) ]-> [ Out( ~privkCA ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Compromise_Bank:
   [ !LtkBank( $Bank, ~privkBank ) ]
  --[ Compromise( $Bank ) ]->
   [ Out( <$Bank, ~privkBank> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Compromise_Card:
   [ !LtkCard( ~PAN, ~privkCard ) ]
  --[ Compromise( ~PAN ) ]->
   [ Out( <~PAN, ~privkCard> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Compromise_Bank_Card_ShK:
   [ !IssuingBank( ~PAN, $Bank ), !Shk( ~PAN, ~MK ) ]
  --[ Compromise( $Bank ), Compromise( ~PAN ) ]->
   [ Out( ~MK ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Set_PIN:
   [ Fr( ~PIN ), Set_PIN( ~PAN, CVM, $CA, $Bank ) ]
  --[
  NEq( CVM, 'NoPIN' ), SecretPIN( ~PIN ), Honest( $CA ), Honest( $Bank ),
  Honest( ~PAN )
  ]->
   [
   !PIN( ~PAN, ~PIN ), !Entered_PIN( ~PAN, ~PIN ),
   !Entered_PIN( ~PAN, 'WrongPIN' )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Create_Card:
   [
   Fr( ~PAN ), Fr( ~expDate ), Fr( ~MK ), !LtkBank( $Bank, ~privkBank ),
   !CertBank( $Bank, certBank ), !IssuingCA( $Bank, $CA ), In( <auth, CVM> )
   ]
  --[
  Role( ~PAN, 'Card' ), SecretPAN( ~PAN ), SecretMK( ~MK ), Honest( $CA ),
  Honest( $Bank ), Honest( ~PAN )
  ]->
   [
   !AIP( ~PAN, <auth, $furtherData> ), !Mastercard( ~PAN ),
   !SupportedCVM( ~PAN, CVM ), !Shk( ~PAN, ~MK ),
   !IssuingBank( ~PAN, $Bank ),
   Set_Records( ~PAN, ~expDate, $CA, certBank,
                sign(<'03', ~PAN, ~expDate, auth, $furtherData>, ~privkBank), CVM
   ),
   Set_PIN( ~PAN, CVM, $CA, $Bank )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Set_Records_SDA:
   [
   Set_Records( ~PAN, ~expDate, $CA, certBank, SSAD, CVM ),
   !AIP( ~PAN, <'SDA', furtherData> )
   ]
  -->
   [ !Records( ~PAN, <~PAN, ~expDate, $CA, certBank, SSAD, CVM> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Set_Records_NotSDA:
   [
   Set_Records( ~PAN, ~expDate, $CA, certBank, SSAD, CVM ),
   Fr( ~privkCard ), !AIP( ~PAN, AIP ), !IssuingBank( ~PAN, $Bank ),
   !LtkBank( $Bank, ~privkBank )
   ]
  --[
  NEq( fst(AIP), 'SDA' ), SecretPrivkCard( ~privkCard ), Honest( $CA ),
  Honest( $Bank ), Honest( ~PAN )
  ]->
   [
   Out( pk(~privkCard) ), !LtkCard( ~PAN, ~privkCard ),
   !Records( ~PAN,
             <~PAN, ~expDate, $CA, certBank, 
              <<'04', ~PAN, pk(~privkCard), $Bank, CVM, AIP>, 
               sign(<'04', ~PAN, pk(~privkCard), $Bank, CVM, AIP>, ~privkBank)>, 
              CVM>
   )
   ]

  /*
  rule (modulo AC) Set_Records_NotSDA:
     [
     Set_Records( ~PAN, ~expDate, $CA, certBank, SSAD, CVM ),
     Fr( ~privkCard ), !AIP( ~PAN, AIP ), !IssuingBank( ~PAN, $Bank ),
     !LtkBank( $Bank, ~privkBank )
     ]
    --[
    NEq( z, 'SDA' ), SecretPrivkCard( ~privkCard ), Honest( $CA ),
    Honest( $Bank ), Honest( ~PAN )
    ]->
     [
     Out( pk(~privkCard) ), !LtkCard( ~PAN, ~privkCard ),
     !Records( ~PAN,
               <~PAN, ~expDate, $CA, certBank, 
                <<'04', ~PAN, pk(~privkCard), $Bank, CVM, AIP>, 
                 sign(<'04', ~PAN, pk(~privkCard), $Bank, CVM, AIP>, ~privkBank)>, 
                CVM>
     )
     ]
    variants (modulo AC)
    1. AIP   = AIP.14
       z     = fst(AIP.14)
    
    2. AIP   = <z.17, x.21>
       z     = z.17
  */

rule (modulo E) Terminal_Sends_GPO:
   [ Fr( ~UN ), !Value( $amount, value ) ]
  --[ OneTerminal( ), Role( $Terminal, 'Terminal' ) ]->
   [
   Out( <'GET_PROCESSING_OPTIONS', $amount, 'Switzerland', 'CHF', 'YYMMDD', 
         'Purchase', ~UN>
   ),
   Terminal_Sent_GPO( $Terminal,
                      <$amount, 'Switzerland', 'CHF', 'YYMMDD', 'Purchase', ~UN>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_GPO:
   [
   In( <'GET_PROCESSING_OPTIONS', PDOL> ), !AIP( ~PAN, AIP ),
   !Mastercard( ~PAN ), !ATC( ATC )
   ]
  --[ OneCard( ), Once( <~PAN, ATC, 'Card'> ) ]->
   [ Out( <AIP, 'AFL'> ), Card_Responded_To_GPO( ~PAN, PDOL, ATC ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_ReadRecord:
   [ Terminal_Sent_GPO( $Terminal, PDOL ), In( <AIP, 'AFL'> ) ]
  -->
   [
   Out( <'READ_RECORD', 'AFL'> ),
   Terminal_Sent_ReadRecord( $Terminal, PDOL, AIP )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_ReadRecord_NotDDA:
   [
   Card_Responded_To_GPO( ~PAN, PDOL, ATC ), !AIP( ~PAN, AIP ),
   !Records( ~PAN, records ), In( <'READ_RECORD', 'AFL'> )
   ]
  --[ NEq( fst(AIP), 'DDA' ) ]->
   [ Out( records ), Card_Ready_For_Transaction( ~PAN, PDOL, ATC ) ]

  /*
  rule (modulo AC) Card_Responds_To_ReadRecord_NotDDA:
     [
     Card_Responded_To_GPO( ~PAN, PDOL, ATC ), !AIP( ~PAN, AIP ),
     !Records( ~PAN, records ), In( <'READ_RECORD', 'AFL'> )
     ]
    --[ NEq( z, 'DDA' ) ]->
     [ Out( records ), Card_Ready_For_Transaction( ~PAN, PDOL, ATC ) ]
    variants (modulo AC)
    1. AIP   = AIP.10
       z     = fst(AIP.10)
    
    2. AIP   = <z.15, x.21>
       z     = z.15
  */

rule (modulo E) Card_Responds_To_ReadRecord_DDA:
   [
   Card_Responded_To_GPO( ~PAN, PDOL, ATC ), !Records( ~PAN, records ),
   !AIP( ~PAN, <'DDA', furtherData> ), In( <'READ_RECORD', 'AFL'> )
   ]
  -->
   [ Out( records ), Card_Ready_For_DDA( ~PAN, PDOL, ATC ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_Records_SDA:
   [
   Terminal_Sent_ReadRecord( $Terminal, PDOL, <'SDA', furtherData> ),
   In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, SSAD, CVM
       >
   ),
   !IssuingCA( $Bank, $CA ),
   !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
   ]
  --[
  Eq( verify(sign1, <'01', $CA, pubkCA, $CA>, pubkCA), true ),
  Eq( verify(sign2, <'02', $Bank, pubkBank, $CA>, pubkCA), true ),
  Eq( verify(SSAD, <'03', ~PAN, expDate, 'SDA', furtherData>, pubkBank),
      true
  )
  ]->
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA, PDOL,
                           <'SDA', furtherData>, pubkBank, 'Null', CVM
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_Records_SDA:
     [
     Terminal_Sent_ReadRecord( $Terminal, PDOL, <'SDA', furtherData> ),
     In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, SSAD, CVM
         >
     ),
     !IssuingCA( $Bank, $CA ),
     !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
     ]
    --[ Eq( z, true ), Eq( z.1, true ), Eq( z.2, true ) ]->
     [
     Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA, PDOL,
                             <'SDA', furtherData>, pubkBank, 'Null', CVM
     )
     ]
    variants (modulo AC)
    1. $Bank = $Bank.34
       $CA   = $CA.35
       ~PAN  = ~PAN.37
       SSAD  = SSAD.40
       expDate
             = expDate.41
       furtherData
             = furtherData.42
       pubkBank
             = pubkBank.43
       pubkCA
             = pubkCA.44
       sign1 = sign1.45
       sign2 = sign2.46
       z     = verify(sign1.45, <'01', $CA.35, pubkCA.44, $CA.35>, pubkCA.44)
       z.1   = verify(sign2.46, <'02', $Bank.34, pubkBank.43, $CA.35>,
                      pubkCA.44)
       z.2   = verify(SSAD.40,
                      <'03', ~PAN.37, expDate.41, 'SDA', furtherData.42>, pubkBank.43)
    
    2. $Bank = $Bank.87
       $CA   = $CA.88
       ~PAN  = ~PAN.90
       SSAD  = sign(<'03', ~PAN.90, expDate.94, 'SDA', furtherData.95>, x.172)
       expDate
             = expDate.94
       furtherData
             = furtherData.95
       pubkBank
             = pk(x.172)
       pubkCA
             = pubkCA.97
       sign1 = sign1.98
       sign2 = sign2.99
       z     = verify(sign1.98, <'01', $CA.88, pubkCA.97, $CA.88>, pubkCA.97)
       z.1   = verify(sign2.99, <'02', $Bank.87, pk(x.172), $CA.88>, pubkCA.97)
       z.2   = true
    
    3. $Bank = $Bank.90
       $CA   = $CA.91
       ~PAN  = ~PAN.93
       SSAD  = sign(<'03', ~PAN.93, expDate.97, 'SDA', furtherData.98>, x.177)
       expDate
             = expDate.97
       furtherData
             = furtherData.98
       pubkBank
             = pk(x.177)
       pubkCA
             = pk(x.178)
       sign1 = sign(<'01', $CA.91, pk(x.178), $CA.91>, x.178)
       sign2 = sign2.102
       z     = true
       z.1   = verify(sign2.102, <'02', $Bank.90, pk(x.177), $CA.91>, pk(x.178))
       z.2   = true
    
    4. $Bank = $Bank.91
       $CA   = $CA.92
       ~PAN  = ~PAN.94
       SSAD  = SSAD.97
       expDate
             = expDate.98
       furtherData
             = furtherData.99
       pubkBank
             = pubkBank.100
       pubkCA
             = pk(x.180)
       sign1 = sign(<'01', $CA.92, pk(x.180), $CA.92>, x.180)
       sign2 = sign2.103
       z     = true
       z.1   = verify(sign2.103, <'02', $Bank.91, pubkBank.100, $CA.92>,
                      pk(x.180))
       z.2   = verify(SSAD.97,
                      <'03', ~PAN.94, expDate.98, 'SDA', furtherData.99>, pubkBank.100)
    
    5. $Bank = $Bank.91
       $CA   = $CA.92
       ~PAN  = ~PAN.94
       SSAD  = sign(<'03', ~PAN.94, expDate.98, 'SDA', furtherData.99>, x.179)
       expDate
             = expDate.98
       furtherData
             = furtherData.99
       pubkBank
             = pk(x.179)
       pubkCA
             = pk(x.180)
       sign1 = sign1.102
       sign2 = sign(<'02', $Bank.91, pk(x.179), $CA.92>, x.180)
       z     = verify(sign1.102, <'01', $CA.92, pk(x.180), $CA.92>, pk(x.180))
       z.1   = true
       z.2   = true
    
    6. $Bank = $Bank.91
       $CA   = $CA.92
       ~PAN  = ~PAN.94
       SSAD  = sign(<'03', ~PAN.94, expDate.98, 'SDA', furtherData.99>, x.179)
       expDate
             = expDate.98
       furtherData
             = furtherData.99
       pubkBank
             = pk(x.179)
       pubkCA
             = pk(x.180)
       sign1 = sign(<'01', $CA.92, pk(x.180), $CA.92>, x.180)
       sign2 = sign(<'02', $Bank.91, pk(x.179), $CA.92>, x.180)
       z     = true
       z.1   = true
       z.2   = true
    
    7. $Bank = $Bank.92
       $CA   = $CA.93
       ~PAN  = ~PAN.95
       SSAD  = SSAD.98
       expDate
             = expDate.99
       furtherData
             = furtherData.100
       pubkBank
             = pubkBank.101
       pubkCA
             = pk(x.182)
       sign1 = sign1.103
       sign2 = sign(<'02', $Bank.92, pubkBank.101, $CA.93>, x.182)
       z     = verify(sign1.103, <'01', $CA.93, pk(x.182), $CA.93>, pk(x.182))
       z.1   = true
       z.2   = verify(SSAD.98,
                      <'03', ~PAN.95, expDate.99, 'SDA', furtherData.100>, pubkBank.101)
    
    8. $Bank = $Bank.92
       $CA   = $CA.93
       ~PAN  = ~PAN.95
       SSAD  = SSAD.98
       expDate
             = expDate.99
       furtherData
             = furtherData.100
       pubkBank
             = pubkBank.101
       pubkCA
             = pk(x.182)
       sign1 = sign(<'01', $CA.93, pk(x.182), $CA.93>, x.182)
       sign2 = sign(<'02', $Bank.92, pubkBank.101, $CA.93>, x.182)
       z     = true
       z.1   = true
       z.2   = verify(SSAD.98,
                      <'03', ~PAN.95, expDate.99, 'SDA', furtherData.100>, pubkBank.101)
  */

rule (modulo E) Terminal_Receives_Records_CDA:
   [
   Terminal_Sent_ReadRecord( $Terminal, PDOL, <'CDA', furtherData> ),
   In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
        <<'04', ~PAN, pubkCard, $Bank, CVM, 'CDA', furtherData>, sign3>, CVM>
   ),
   !IssuingCA( $Bank, $CA ),
   !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
   ]
  --[
  Eq( verify(sign1, <'01', $CA, pubkCA, $CA>, pubkCA), true ),
  Eq( verify(sign2, <'02', $Bank, pubkBank, $CA>, pubkCA), true ),
  Eq( verify(sign3, <'04', ~PAN, pubkCard, $Bank, CVM, 'CDA', furtherData>,
             pubkBank),
      true
  )
  ]->
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA, PDOL,
                           <'CDA', furtherData>, pubkBank, pubkCard, CVM
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_Records_CDA:
     [
     Terminal_Sent_ReadRecord( $Terminal, PDOL, <'CDA', furtherData> ),
     In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
          <<'04', ~PAN, pubkCard, $Bank, CVM, 'CDA', furtherData>, sign3>, CVM>
     ),
     !IssuingCA( $Bank, $CA ),
     !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
     ]
    --[ Eq( z, true ), Eq( z.1, true ), Eq( z.2, true ) ]->
     [
     Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA, PDOL,
                             <'CDA', furtherData>, pubkBank, pubkCard, CVM
     )
     ]
    variants (modulo AC)
    1. $Bank = $Bank.36
       $CA   = $CA.37
       ~PAN  = ~PAN.39
       CVM   = CVM.40
       furtherData
             = furtherData.43
       pubkBank
             = pubkBank.44
       pubkCA
             = pubkCA.45
       pubkCard
             = pubkCard.46
       sign1 = sign1.47
       sign2 = sign2.48
       sign3 = sign3.49
       z     = verify(sign1.47, <'01', $CA.37, pubkCA.45, $CA.37>, pubkCA.45)
       z.1   = verify(sign2.48, <'02', $Bank.36, pubkBank.44, $CA.37>,
                      pubkCA.45)
       z.2   = verify(sign3.49,
                      <'04', ~PAN.39, pubkCard.46, $Bank.36, CVM.40, 'CDA', furtherData.43>,
                      pubkBank.44)
    
    2. $Bank = $Bank.94
       $CA   = $CA.95
       ~PAN  = ~PAN.97
       CVM   = CVM.98
       furtherData
             = furtherData.101
       pubkBank
             = pubkBank.102
       pubkCA
             = pk(x.186)
       pubkCard
             = pubkCard.104
       sign1 = sign(<'01', $CA.95, pk(x.186), $CA.95>, x.186)
       sign2 = sign2.106
       sign3 = sign3.107
       z     = true
       z.1   = verify(sign2.106, <'02', $Bank.94, pubkBank.102, $CA.95>,
                      pk(x.186))
       z.2   = verify(sign3.107,
                      <'04', ~PAN.97, pubkCard.104, $Bank.94, CVM.98, 'CDA', furtherData.101>,
                      pubkBank.102)
    
    3. $Bank = $Bank.94
       $CA   = $CA.95
       ~PAN  = ~PAN.97
       CVM   = CVM.98
       furtherData
             = furtherData.101
       pubkBank
             = pk(x.186)
       pubkCA
             = pubkCA.103
       pubkCard
             = pubkCard.104
       sign1 = sign1.105
       sign2 = sign2.106
       sign3 = sign(<'04', ~PAN.97, pubkCard.104, $Bank.94, CVM.98, 'CDA', 
                     furtherData.101>,
                    x.186)
       z     = verify(sign1.105, <'01', $CA.95, pubkCA.103, $CA.95>, pubkCA.103)
       z.1   = verify(sign2.106, <'02', $Bank.94, pk(x.186), $CA.95>,
                      pubkCA.103)
       z.2   = true
    
    4. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pubkBank.103
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign1.106
       sign2 = sign(<'02', $Bank.95, pubkBank.103, $CA.96>, x.188)
       sign3 = sign3.108
       z     = verify(sign1.106, <'01', $CA.96, pk(x.188), $CA.96>, pk(x.188))
       z.1   = true
       z.2   = verify(sign3.108,
                      <'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'CDA', furtherData.102>,
                      pubkBank.103)
    
    5. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pubkBank.103
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign(<'02', $Bank.95, pubkBank.103, $CA.96>, x.188)
       sign3 = sign3.108
       z     = true
       z.1   = true
       z.2   = verify(sign3.108,
                      <'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'CDA', furtherData.102>,
                      pubkBank.103)
    
    6. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign1.106
       sign2 = sign(<'02', $Bank.95, pk(x.187), $CA.96>, x.188)
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'CDA', 
                     furtherData.102>,
                    x.187)
       z     = verify(sign1.106, <'01', $CA.96, pk(x.188), $CA.96>, pk(x.188))
       z.1   = true
       z.2   = true
    
    7. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign2.107
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'CDA', 
                     furtherData.102>,
                    x.187)
       z     = true
       z.1   = verify(sign2.107, <'02', $Bank.95, pk(x.187), $CA.96>, pk(x.188))
       z.2   = true
    
    8. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign(<'02', $Bank.95, pk(x.187), $CA.96>, x.188)
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'CDA', 
                     furtherData.102>,
                    x.187)
       z     = true
       z.1   = true
       z.2   = true
  */

rule (modulo E) Terminal_Receives_Records_DDA:
   [
   Terminal_Sent_ReadRecord( $Terminal, PDOL, <'DDA', furtherData> ),
   !IssuingCA( $Bank, $CA ),
   In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
        <<'04', ~PAN, pubkCard, $Bank, CVM, 'DDA', furtherData>, sign3>, CVM>
   ),
   !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
   ]
  --[
  Eq( verify(sign1, <'01', $CA, pubkCA, $CA>, pubkCA), true ),
  Eq( verify(sign2, <'02', $Bank, pubkBank, $CA>, pubkCA), true ),
  Eq( verify(sign3, <'04', ~PAN, pubkCard, $Bank, CVM, 'DDA', furtherData>,
             pubkBank),
      true
  )
  ]->
   [
   Terminal_Ready_For_DDA( $Terminal, ~PAN, $Bank, $CA, PDOL,
                           <'DDA', furtherData>, pubkBank, pubkCard, CVM
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_Records_DDA:
     [
     Terminal_Sent_ReadRecord( $Terminal, PDOL, <'DDA', furtherData> ),
     !IssuingCA( $Bank, $CA ),
     In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
          <<'04', ~PAN, pubkCard, $Bank, CVM, 'DDA', furtherData>, sign3>, CVM>
     ),
     !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
     ]
    --[ Eq( z, true ), Eq( z.1, true ), Eq( z.2, true ) ]->
     [
     Terminal_Ready_For_DDA( $Terminal, ~PAN, $Bank, $CA, PDOL,
                             <'DDA', furtherData>, pubkBank, pubkCard, CVM
     )
     ]
    variants (modulo AC)
    1. $Bank = $Bank.36
       $CA   = $CA.37
       ~PAN  = ~PAN.39
       CVM   = CVM.40
       furtherData
             = furtherData.43
       pubkBank
             = pubkBank.44
       pubkCA
             = pubkCA.45
       pubkCard
             = pubkCard.46
       sign1 = sign1.47
       sign2 = sign2.48
       sign3 = sign3.49
       z     = verify(sign1.47, <'01', $CA.37, pubkCA.45, $CA.37>, pubkCA.45)
       z.1   = verify(sign2.48, <'02', $Bank.36, pubkBank.44, $CA.37>,
                      pubkCA.45)
       z.2   = verify(sign3.49,
                      <'04', ~PAN.39, pubkCard.46, $Bank.36, CVM.40, 'DDA', furtherData.43>,
                      pubkBank.44)
    
    2. $Bank = $Bank.94
       $CA   = $CA.95
       ~PAN  = ~PAN.97
       CVM   = CVM.98
       furtherData
             = furtherData.101
       pubkBank
             = pubkBank.102
       pubkCA
             = pk(x.186)
       pubkCard
             = pubkCard.104
       sign1 = sign(<'01', $CA.95, pk(x.186), $CA.95>, x.186)
       sign2 = sign2.106
       sign3 = sign3.107
       z     = true
       z.1   = verify(sign2.106, <'02', $Bank.94, pubkBank.102, $CA.95>,
                      pk(x.186))
       z.2   = verify(sign3.107,
                      <'04', ~PAN.97, pubkCard.104, $Bank.94, CVM.98, 'DDA', furtherData.101>,
                      pubkBank.102)
    
    3. $Bank = $Bank.94
       $CA   = $CA.95
       ~PAN  = ~PAN.97
       CVM   = CVM.98
       furtherData
             = furtherData.101
       pubkBank
             = pk(x.186)
       pubkCA
             = pubkCA.103
       pubkCard
             = pubkCard.104
       sign1 = sign1.105
       sign2 = sign2.106
       sign3 = sign(<'04', ~PAN.97, pubkCard.104, $Bank.94, CVM.98, 'DDA', 
                     furtherData.101>,
                    x.186)
       z     = verify(sign1.105, <'01', $CA.95, pubkCA.103, $CA.95>, pubkCA.103)
       z.1   = verify(sign2.106, <'02', $Bank.94, pk(x.186), $CA.95>,
                      pubkCA.103)
       z.2   = true
    
    4. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pubkBank.103
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign1.106
       sign2 = sign(<'02', $Bank.95, pubkBank.103, $CA.96>, x.188)
       sign3 = sign3.108
       z     = verify(sign1.106, <'01', $CA.96, pk(x.188), $CA.96>, pk(x.188))
       z.1   = true
       z.2   = verify(sign3.108,
                      <'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'DDA', furtherData.102>,
                      pubkBank.103)
    
    5. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pubkBank.103
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign(<'02', $Bank.95, pubkBank.103, $CA.96>, x.188)
       sign3 = sign3.108
       z     = true
       z.1   = true
       z.2   = verify(sign3.108,
                      <'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'DDA', furtherData.102>,
                      pubkBank.103)
    
    6. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign1.106
       sign2 = sign(<'02', $Bank.95, pk(x.187), $CA.96>, x.188)
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'DDA', 
                     furtherData.102>,
                    x.187)
       z     = verify(sign1.106, <'01', $CA.96, pk(x.188), $CA.96>, pk(x.188))
       z.1   = true
       z.2   = true
    
    7. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign2.107
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'DDA', 
                     furtherData.102>,
                    x.187)
       z     = true
       z.1   = verify(sign2.107, <'02', $Bank.95, pk(x.187), $CA.96>, pk(x.188))
       z.2   = true
    
    8. $Bank = $Bank.95
       $CA   = $CA.96
       ~PAN  = ~PAN.98
       CVM   = CVM.99
       furtherData
             = furtherData.102
       pubkBank
             = pk(x.187)
       pubkCA
             = pk(x.188)
       pubkCard
             = pubkCard.105
       sign1 = sign(<'01', $CA.96, pk(x.188), $CA.96>, x.188)
       sign2 = sign(<'02', $Bank.95, pk(x.187), $CA.96>, x.188)
       sign3 = sign(<'04', ~PAN.98, pubkCard.105, $Bank.95, CVM.99, 'DDA', 
                     furtherData.102>,
                    x.187)
       z     = true
       z.1   = true
       z.2   = true
  */

rule (modulo E) Terminal_Sends_InternalAuthenticate:
   [
   Terminal_Ready_For_DDA( $Terminal, ~PAN, $Bank, $CA,
                           <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                           CVM
   )
   ]
  -->
   [
   Out( <'INTERNAL_AUTHENTICATE', ~UN> ),
   Terminal_Sent_InternalAuthenticate( $Terminal, ~PAN, $Bank, $CA,
                                       <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                                       CVM
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_InternalAuthenticate:
   [
   Card_Ready_For_DDA( ~PAN, PDOL, ATC ), Fr( ~nc ),
   !LtkCard( ~PAN, ~privkCard ), In( <'INTERNAL_AUTHENTICATE', DDOL> )
   ]
  -->
   [
   Out( <~nc, sign(<'05', ~nc, DDOL>, ~privkCard)> ),
   Card_Ready_For_Transaction( ~PAN, PDOL, ATC )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_InternalAuthenticate_Response:
   [
   Terminal_Sent_InternalAuthenticate( $Terminal, ~PAN, $Bank, $CA,
                                       <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                                       CVM
   ),
   In( <nc, SDAD> )
   ]
  --[ Eq( verify(SDAD, <'05', nc, ~UN>, pubkCard), true ) ]->
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA,
                           <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                           CVM
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_InternalAuthenticate_Response:
     [
     Terminal_Sent_InternalAuthenticate( $Terminal, ~PAN, $Bank, $CA,
                                         <$amount, country, currency, date, type, ~UN>, AIP, pubkBank,
                                         pubkCard, CVM
     ),
     In( <nc, SDAD> )
     ]
    --[ Eq( z, true ) ]->
     [
     Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA,
                             <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                             CVM
     )
     ]
    variants (modulo AC)
    1. ~UN   = ~UN.18
       SDAD  = SDAD.18
       nc    = nc.18
       pubkCard
             = pubkCard.18
       z     = verify(SDAD.18, <'05', nc.18, ~UN.18>, pubkCard.18)
    
    2. ~UN   = ~x.18
       SDAD  = sign(<'05', x.21, ~x.18>, x.22)
       nc    = x.21
       pubkCard
             = pk(x.22)
       z     = true
  */

rule (modulo E) Terminal_Processes_CVM_NoPIN:
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA,
                           <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                           CVM
   ),
   !Value( $amount, 'Low' )
   ]
  -->
   [
   Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA,
                                   <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                                   'NoPIN', 'Null', CVM
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Processes_CVM_OnlinePIN:
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA,
                           <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                           'OnlinePIN'
   ),
   !Entered_PIN( ~PAN, PIN ), !Value( $amount, 'High' )
   ]
  -->
   [
   Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA,
                                   <$amount, country, currency, date, type, ~UN>, AIP, pubkBank, pubkCard,
                                   'OnlinePIN', aenc(PIN, pubkBank), 'OnlinePIN'
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Processes_CVM_ODCVM:
   [
   Terminal_Ready_For_CVM( $Terminal, ~PAN, $Bank, $CA,
                           <$amount, country, currency, date, type, ~UN>,
                           <auth, 'ODCVM', furtherData2>, pubkBank, pubkCard, CVM
   ),
   !Value( $amount, 'High' )
   ]
  -->
   [
   Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA,
                                   <$amount, country, currency, date, type, ~UN>,
                                   <auth, 'ODCVM', furtherData2>, pubkBank, pubkCard, 'ODCVM', 'Null', CVM
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_GenerateAC_NoCDA:
   [
   Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA, PDOL, AIP,
                                   pubkBank, pubkCard, CVM, encPIN, supportedCVM
   ),
   In( acType )
   ]
  --[ NEq( fst(AIP), 'CDA' ) ]->
   [
   Out( <'GENERATE_AC', acType, 'NoCDA', 'TVR', CVM, 'HHMMSS'> ),
   Terminal_Sent_GenerateAC_NoCDA( $Terminal, ~PAN, $Bank, $CA,
                                   <PDOL, 'TVR', CVM, 'HHMMSS'>, AIP, pubkBank, pubkCard, CVM, encPIN,
                                   acType, supportedCVM
   )
   ]

  /*
  rule (modulo AC) Terminal_Sends_GenerateAC_NoCDA:
     [
     Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA, PDOL, AIP,
                                     pubkBank, pubkCard, CVM, encPIN, supportedCVM
     ),
     In( acType )
     ]
    --[ NEq( z, 'CDA' ) ]->
     [
     Out( <'GENERATE_AC', acType, 'NoCDA', 'TVR', CVM, 'HHMMSS'> ),
     Terminal_Sent_GenerateAC_NoCDA( $Terminal, ~PAN, $Bank, $CA,
                                     <PDOL, 'TVR', CVM, 'HHMMSS'>, AIP, pubkBank, pubkCard, CVM, encPIN,
                                     acType, supportedCVM
     )
     ]
    variants (modulo AC)
    1. AIP   = AIP.19
       z     = fst(AIP.19)
    
    2. AIP   = <z.28, x.38>
       z     = z.28
  */

rule (modulo E) Terminal_Sends_GenerateAC_CDA:
   [
   Terminal_Ready_For_Transaction( $Terminal, ~PAN, $Bank, $CA, PDOL,
                                   <'CDA', furtherData>, pubkBank, pubkCard, CVM, encPIN, supportedCVM
   ),
   In( acType )
   ]
  -->
   [
   Out( <'GENERATE_AC', acType, 'CDA', 'TVR', CVM, 'HHMMSS'> ),
   Terminal_Sent_GenerateAC_CDA( $Terminal, ~PAN, $Bank, $CA,
                                 <PDOL, 'TVR', CVM, 'HHMMSS'>, <'CDA', furtherData>, pubkBank, pubkCard,
                                 CVM, encPIN, acType, supportedCVM
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_GenerateAC_NoCDA:
   [
   Card_Ready_For_Transaction( ~PAN, PDOL, ATC ), !AIP( ~PAN, AIP ),
   !Shk( ~PAN, ~MK ), !IssuingBank( ~PAN, $Bank ),
   In( <'GENERATE_AC', CID, 'NoCDA', 'TVR', CVM, 'HHMMSS'> )
   ]
  --[
  Running( ~PAN, 'Null',
           <'Card', 'Terminal', ~PAN, AIP, CVM, <PDOL, 'TVR', CVM, 'HHMMSS'>, ATC, 
            MAC(f(~MK, ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, AIP, ATC, <'IAD', CID>), 
            'IAD', CID>
  ),
  Running( ~PAN, $Bank,
           <'Card', 'Bank', ~PAN, AIP, CVM, <PDOL, 'TVR', CVM, 'HHMMSS'>, ATC, 
            MAC(f(~MK, ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, AIP, ATC, <'IAD', CID>), 
            'IAD', CID>
  )
  ]->
   [
   Out( <CID, ATC, 
         MAC(f(~MK, ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, AIP, ATC, <'IAD', CID>), 
         'IAD', CID>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_GenerateAC_CDA:
   [
   Card_Ready_For_Transaction( ~PAN,
                               <amount, country, currency, date, type, UN>, ATC
   ),
   !LtkCard( ~PAN, ~privkCard ), !AIP( ~PAN, <'CDA', furtherData> ),
   !Shk( ~PAN, ~MK ), !IssuingBank( ~PAN, $Bank ), Fr( ~nc ),
   In( <'GENERATE_AC', CID, 'CDA', 'TVR', CVM, 'HHMMSS'> )
   ]
  --[
  Running( ~PAN, ~nc,
           <'Card', 'Terminal', ~PAN, <'CDA', furtherData>, CVM, 
            <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>, 
            ATC, 
            MAC(f(~MK, ATC),
                <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
                <'CDA', furtherData>, ATC, <'IAD', CID>), 
            'IAD', CID>
  ),
  Running( ~PAN, $Bank,
           <'Card', 'Bank', ~PAN, <'CDA', furtherData>, CVM, 
            <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>, 
            ATC, 
            MAC(f(~MK, ATC),
                <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
                <'CDA', furtherData>, ATC, <'IAD', CID>), 
            'IAD', CID>
  )
  ]->
   [
   Out( <CID, ATC, 
         MAC(f(~MK, ATC),
             <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
             <'CDA', furtherData>, ATC, <'IAD', CID>), 
         <~nc, 
          sign(<'05', ~nc, CID, 
                MAC(f(~MK, ATC),
                    <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
                    <'CDA', furtherData>, ATC, <'IAD', CID>), 
                h(<<<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>, 
                   CID, ATC, 
                   MAC(f(~MK, ATC),
                       <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
                       <'CDA', furtherData>, ATC, <'IAD', CID>), 
                   'IAD', CID>), 
                UN>,
               ~privkCard)
         >, 
         'IAD', CID>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_AC_NoCDA:
   [
   Terminal_Sent_GenerateAC_NoCDA( $Terminal, ~PAN, $Bank, $CA,
                                   <PDOL, CDOL1>, AIP, pubkBank, pubkCard, CVM, encPIN, acType, supportedCVM
   ),
   In( <CID, ATC, AC, IAD> ), Fr( ~channelID )
   ]
  --[
  Compatible_CID_acType( CID, acType ), Compatible_CID_CVM( CID, CVM ),
  Running( $Terminal, $Bank,
           <'Terminal', 'Bank', ~PAN, AIP, CVM, <PDOL, CDOL1>, ATC, AC, IAD>
  )
  ]->
   [
   Terminal_Received_AC( $Terminal, $Bank, $CA, 'Null', CID,
                         <~PAN, AIP, CVM, <PDOL, CDOL1>, ATC, AC, IAD>, supportedCVM, ~channelID
   ),
   Send( $Terminal, $Bank, <~channelID, 'Mastercard', '1'>,
         <<~PAN, AIP, CVM, <PDOL, CDOL1>, ATC, AC, IAD>, encPIN>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_AC_CDA:
   [
   Terminal_Sent_GenerateAC_CDA( $Terminal, ~PAN, $Bank, $CA,
                                 <<$amount, country, currency, date, type, ~UN>, CDOL1>, AIP, pubkBank,
                                 pubkCard, CVM, encPIN, acType, supportedCVM
   ),
   In( <CID, ATC, AC, <nc, SDAD>, IAD> ), Fr( ~channelID )
   ]
  --[
  Compatible_CID_acType( CID, acType ), Compatible_CID_CVM( CID, CVM ),
  Eq( verify(SDAD,
             <'05', nc, CID, AC, 
              h(<<<$amount, country, currency, date, type, ~UN>, CDOL1>, CID, ATC, AC, 
                 IAD>), 
              ~UN>,
             pubkCard),
      true
  ),
  Running( $Terminal, $Bank,
           <'Terminal', 'Bank', ~PAN, AIP, CVM, 
            <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  )
  ]->
   [
   Terminal_Received_AC( $Terminal, $Bank, $CA, nc, CID,
                         <~PAN, AIP, CVM, <<$amount, country, currency, date, type, ~UN>, CDOL1>, 
                          ATC, AC, IAD>,
                         supportedCVM, ~channelID
   ),
   Send( $Terminal, $Bank, <~channelID, 'Mastercard', '1'>,
         <
          <~PAN, AIP, CVM, <<$amount, country, currency, date, type, ~UN>, CDOL1>, 
           ATC, AC, IAD>, 
          encPIN>
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_AC_CDA:
     [
     Terminal_Sent_GenerateAC_CDA( $Terminal, ~PAN, $Bank, $CA,
                                   <<$amount, country, currency, date, type, ~UN>, CDOL1>, AIP, pubkBank,
                                   pubkCard, CVM, encPIN, acType, supportedCVM
     ),
     In( <CID, ATC, AC, <nc, SDAD>, IAD> ), Fr( ~channelID )
     ]
    --[
    Compatible_CID_acType( CID, acType ), Compatible_CID_CVM( CID, CVM ),
    Eq( z, true ),
    Running( $Terminal, $Bank,
             <'Terminal', 'Bank', ~PAN, AIP, CVM, 
              <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
    )
    ]->
     [
     Terminal_Received_AC( $Terminal, $Bank, $CA, nc, CID,
                           <~PAN, AIP, CVM, <<$amount, country, currency, date, type, ~UN>, CDOL1>, 
                            ATC, AC, IAD>,
                           supportedCVM, ~channelID
     ),
     Send( $Terminal, $Bank, <~channelID, 'Mastercard', '1'>,
           <
            <~PAN, AIP, CVM, <<$amount, country, currency, date, type, ~UN>, CDOL1>, 
             ATC, AC, IAD>, 
            encPIN>
     )
     ]
    variants (modulo AC)
    1. $amount
             = $amount.51
       ~UN   = ~UN.53
       AC    = AC.55
       ATC   = ATC.57
       CDOL1 = CDOL1.58
       CID   = CID.59
       IAD   = IAD.61
       SDAD  = SDAD.62
       country
             = country.64
       currency
             = currency.65
       date  = date.66
       nc    = nc.68
       pubkCard
             = pubkCard.70
       type  = type.72
       z     = verify(SDAD.62,
                      <'05', nc.68, CID.59, AC.55, 
                       h(<
                          <<$amount.51, country.64, currency.65, date.66, type.72, ~UN.53>, 
                           CDOL1.58>, 
                          CID.59, ATC.57, AC.55, IAD.61>), 
                       ~UN.53>,
                      pubkCard.70)
    
    2. $amount
             = $amount.127
       ~UN   = ~UN.129
       AC    = AC.131
       ATC   = ATC.133
       CDOL1 = CDOL1.134
       CID   = CID.135
       IAD   = IAD.137
       SDAD  = sign(<'05', nc.144, CID.135, AC.131, 
                     h(<
                        <<$amount.127, country.140, currency.141, date.142, type.148, ~UN.129>, 
                         CDOL1.134>, 
                        CID.135, ATC.133, AC.131, IAD.137>), 
                     ~UN.129>,
                    x.249)
       country
             = country.140
       currency
             = currency.141
       date  = date.142
       nc    = nc.144
       pubkCard
             = pk(x.249)
       type  = type.148
       z     = true
  */

rule (modulo E) Terminal_Commits_TC:
   [
   Terminal_Received_AC( $Terminal, $Bank, $CA, nc, 'TC',
                         <~PAN, <'DDA', furtherData>, CVM, 
                          <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>,
                         'NoPIN', ~channelID
   ),
   !Value( $amount, 'High' )
   ]
  --[
  TerminalAccepts( <~PAN, <'DDA', furtherData>, CVM, 
                    <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  ),
  Commit( nc, ~PAN,
          <'Card', 'Terminal', ~PAN, <'DDA', furtherData>, CVM, 
           <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  ),
  Honest( $CA ), Honest( $Bank ), Honest( $Terminal ), Honest( ~PAN )
  ]->
   [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Receives_AC:
   [
   Recv( $Terminal, $Bank, <channelID, 'Mastercard', '1'>,
         <<~PAN, AIP, CVM, X, ATC, MAC(f(~MK, ATC), X, AIP, ATC, IAD), IAD>, 
          encPIN>
   ),
   !Shk( ~PAN, ~MK ), !IssuingBank( ~PAN, $Bank )
   ]
  --[ Once( <~PAN, ATC, 'Bank'> ) ]->
   [
   Bank_Checked_AC( $Bank, $Terminal,
                    <~PAN, AIP, CVM, X, ATC, MAC(f(~MK, ATC), X, AIP, ATC, IAD), IAD>,
                    encPIN, channelID,
                    DES3(f(~MK, ATC), (MAC(f(~MK, ATC), X, AIP, ATC, IAD)âŠ•p8('ARC')))
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Receives_AC_Failed:
   [
   Recv( $Terminal, $Bank, <channelID, 'Mastercard', '1'>,
         <<~PAN, AIP, CVM, X, ATC, AC, IAD>, encPIN>
   ),
   !Shk( ~PAN, ~MK )
   ]
  --[
  NEq( MAC(f(~MK, ATC), X, AIP, ATC, IAD), AC ),
  BankDeclines( <~PAN, AIP, CVM, X, ATC, AC, IAD> )
  ]->
   [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Processes_CVM_NotOnlinePIN:
   [
   Bank_Checked_AC( $Bank, $Terminal, <~PAN, AIP, CVM, X, ATC, AC, IAD>,
                    'Null', channelID, ARPC
   )
   ]
  --[
  NEq( CVM, 'OnlinePIN' ),
  Running( $Bank, $Terminal,
           <'Bank', 'Terminal', ~PAN, AIP, CVM, X, ATC, AC, IAD>
  )
  ]->
   [
   Bank_Commits( $Bank, $Terminal, <~PAN, AIP, CVM, X, ATC, AC, IAD>,
                 channelID, ARPC
   )
   ]

  // loop breaker: [0]
  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Commits:
   [
   Bank_Commits( $Bank, $Terminal,
                 <~PAN, <'DDA', furtherData>, CVM, 
                  <<amount, country, currency, date, type, UN>, CDOL1>, ATC, AC, IAD>,
                 channelID, ARPC
   ),
   !Value( amount, 'High' ), !IssuingCA( $Bank, $CA )
   ]
  --[
  Commit( $Bank, ~PAN,
          <'Card', 'Bank', ~PAN, <'DDA', furtherData>, CVM, 
           <<amount, country, currency, date, type, UN>, CDOL1>, ATC, AC, IAD>
  ),
  Commit( $Bank, $Terminal,
          <'Terminal', 'Bank', ~PAN, <'DDA', furtherData>, CVM, 
           <<amount, country, currency, date, type, UN>, CDOL1>, ATC, AC, IAD>
  ),
  Honest( $CA ), Honest( $Bank ), Honest( $Terminal ), Honest( ~PAN )
  ]->
   [ Send( $Bank, $Terminal, <channelID, 'Mastercard', '2'>, <'ARC', ARPC> )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Processes_CVM_OnlinePIN:
   [
   Bank_Checked_AC( $Bank, $Terminal,
                    <~PAN, AIP, 'OnlinePIN', X, ATC, AC, IAD>, aenc(PIN, pk(~privkBank)),
                    channelID, ARPC
   ),
   !LtkBank( $Bank, ~privkBank ), !PIN( ~PAN, PIN ), !Shk( ~PAN, ~MK )
   ]
  --[
  Running( $Bank, $Terminal,
           <'Bank', 'Terminal', ~PAN, AIP, 'OnlinePIN', X, ATC, AC, IAD>
  )
  ]->
   [
   Bank_Commits( $Bank, $Terminal,
                 <~PAN, AIP, 'OnlinePIN', X, ATC, AC, IAD>, channelID, ARPC
   )
   ]

  // loop breaker: [0]
  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Commits_ARQC:
   [
   Terminal_Received_AC( $Terminal, $Bank, $CA, nc, 'ARQC',
                         <~PAN, <'DDA', furtherData>, CVM, 
                          <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>,
                         'NoPIN', ~channelID
   ),
   !Value( $amount, 'High' ),
   Recv( $Bank, $Terminal, <~channelID, 'Mastercard', '2'>, <'ARC', ARPC> )
   ]
  --[
  TerminalAccepts( <~PAN, <'DDA', furtherData>, CVM, 
                    <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  ),
  Commit( nc, ~PAN,
          <'Card', 'Terminal', ~PAN, <'DDA', furtherData>, CVM, 
           <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  ),
  Commit( $Terminal, $Bank,
          <'Bank', 'Terminal', ~PAN, <'DDA', furtherData>, CVM, 
           <<$amount, country, currency, date, type, ~UN>, CDOL1>, ATC, AC, IAD>
  ),
  Honest( $CA ), Honest( $Bank ), Honest( $Terminal ), Honest( ~PAN )
  ]->
   [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) Create_Card_Visa:
   [
   Fr( ~PAN ), Fr( ~expDate ), Fr( ~privkCard ), Fr( ~MK ),
   !LtkBank( $Bank, ~privkBank ), !CertBank( $Bank, certBank ),
   !IssuingCA( $Bank, $CA )
   ]
  --[
  Role( ~PAN, 'Card' ), SecretPAN( ~PAN ), SecretMK( ~MK ),
  SecretPrivkCard( ~privkCard ), Honest( $CA ), Honest( $Bank ),
  Honest( ~PAN )
  ]->
   [
   !LtkCard( ~PAN, ~privkCard ), !Visa( ~PAN ), Out( pk(~privkCard) ),
   !ExpirationDate( ~PAN, ~expDate ), !Shk( ~PAN, ~MK ),
   !IssuingBank( ~PAN, $Bank ),
   !Records_Visa( ~PAN, ~expDate, $CA, certBank,
                  <<'04', ~PAN, pk(~privkCard), $Bank>, 
                   sign(<'04', ~PAN, pk(~privkCard), $Bank>, ~privkBank)>
   ),
   Set_PIN( ~PAN, 'OnlinePIN', $CA, $Bank )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_GPO_Low_Visa:
   [ Fr( ~UN ), !Value( $amount, 'Low' ) ]
  --[ OneTerminal( ), Role( $Terminal, 'Terminal' ) ]->
   [
   Out( <'GET_PROCESSING_OPTIONS', <'TC', 'NoPIN'>, $amount, 'Switzerland', 
         'CHF', 'YYMMDD', 'Purchase', ~UN>
   ),
   Terminal_Sent_GPO_Visa( $Terminal,
                           <<'TC', 'NoPIN'>, $amount, 'Switzerland', 'CHF', 'YYMMDD', 'Purchase', 
                            ~UN>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_GPO_High_Visa:
   [ Fr( ~UN ), !Value( $amount, 'High' ) ]
  --[ OneTerminal( ), Role( $Terminal, 'Terminal' ) ]->
   [
   Out( <'GET_PROCESSING_OPTIONS', <'ARQC', 'OnlinePIN'>, $amount, 
         'Switzerland', 'CHF', 'YYMMDD', 'Purchase', ~UN>
   ),
   Terminal_Sent_GPO_Visa( $Terminal,
                           <<'ARQC', 'OnlinePIN'>, $amount, 'Switzerland', 'CHF', 'YYMMDD', 
                            'Purchase', ~UN>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_GPO_EMV_Visa:
   [
   In( <'GET_PROCESSING_OPTIONS', <acType, CVM>, amount, country, currency, 
        date, type, UN>
   ),
   !Shk( ~PAN, ~MK ), !Visa( ~PAN ), !ExpirationDate( ~PAN, ~expDate ),
   !IssuingBank( ~PAN, $Bank ), !ATC( ATC )
   ]
  --[
  OneCard( ), Once( <~PAN, ATC, 'Card'> ), NEq( CVM, 'CDCVM' ),
  Running( ~PAN, 'Null',
           <'Card', 'Terminal', ~PAN, <'EMV', $furtherData>, CVM, 
            <<acType, CVM>, amount, country, currency, date, type, UN>, ATC, 
            MAC(f(~MK, ATC),
                <<acType, CVM>, amount, country, currency, date, type, UN>,
                <'EMV', $furtherData>, ATC, <'IAD', 'ARQC'>), 
            'IAD', 'ARQC'>
  ),
  Running( ~PAN, $Bank,
           <'Card', 'Bank', ~PAN, <'EMV', $furtherData>, CVM, 
            <<acType, CVM>, amount, country, currency, date, type, UN>, ATC, 
            MAC(f(~MK, ATC),
                <<acType, CVM>, amount, country, currency, date, type, UN>,
                <'EMV', $furtherData>, ATC, <'IAD', 'ARQC'>), 
            'IAD', 'ARQC'>
  )
  ]->
   [
   Out( <<'EMV', $furtherData>, 'AFL', <~PAN, ~expDate>, <'IAD', 'ARQC'>, 
         MAC(f(~MK, ATC),
             <<acType, CVM>, amount, country, currency, date, type, UN>,
             <'EMV', $furtherData>, ATC, <'IAD', 'ARQC'>), 
         'ARQC', ATC, CVM>
   ),
   Card_Responded_To_GPO_Visa( ~PAN, <'EMV', $furtherData>,
                               <<acType, CVM>, amount, country, currency, date, type, UN>, ATC,
                               MAC(f(~MK, ATC),
                                   <<acType, CVM>, amount, country, currency, date, type, UN>,
                                   <'EMV', $furtherData>, ATC, <'IAD', 'ARQC'>),
                               'ARQC', CVM, <'IAD', 'ARQC'>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_GPO_DDA_Visa:
   [
   In( <'GET_PROCESSING_OPTIONS', <CID, CVM>, amount, country, currency, 
        date, type, UN>
   ),
   !Shk( ~PAN, ~MK ), !Visa( ~PAN ), !ExpirationDate( ~PAN, ~expDate ),
   !ATC( ATC )
   ]
  --[ OneCard( ), Once( <~PAN, ATC, 'Card'> ), NEq( CVM, 'CDCVM' ) ]->
   [
   Out( <<'DDA', $furtherData>, 'AFL', <~PAN, ~expDate>, <'IAD', CID>, 
         MAC(f(~MK, ATC), <<CID, CVM>, amount, country, currency, date, type, UN>,
             <'DDA', $furtherData>, ATC, <'IAD', CID>), 
         CID, ATC, CVM>
   ),
   Card_Responded_To_GPO_Visa( ~PAN, <'DDA', $furtherData>,
                               <<CID, CVM>, amount, country, currency, date, type, UN>, ATC,
                               MAC(f(~MK, ATC), <<CID, CVM>, amount, country, currency, date, type, UN>,
                                   <'DDA', $furtherData>, ATC, <'IAD', CID>),
                               CID, CVM, <'IAD', CID>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_ReadRecord_Visa:
   [
   Terminal_Sent_GPO_Visa( $Terminal,
                           <<acType, CVM>, $amount, country, currency, date, type, ~UN>
   ),
   In( <AIP, 'AFL', <~PAN, expDate>, IAD, AC, CID, ATC, CTQ> )
   ]
  --[ Compatible_CID_acType( CID, acType ) ]->
   [
   Out( <'READ_RECORD', 'AFL'> ),
   Terminal_Sent_ReadRecord_Visa( $Terminal,
                                  <<acType, CVM>, $amount, country, currency, date, type, ~UN>, AIP, ~PAN,
                                  expDate, IAD, AC, CID, ATC, CTQ
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_ReadRecord_EMV_Visa:
   [
   Card_Responded_To_GPO_Visa( ~PAN, <'EMV', furtherData>, PDOL, ATC, AC,
                               CID, CTQ, IAD
   ),
   !Records_Visa( ~PAN, ~expDate, $CA, certBank, certCard ),
   In( <'READ_RECORD', 'AFL'> )
   ]
  -->
   [ Out( <~PAN, ~expDate> ) ]

  /* has exactly the trivial AC variant */

rule (modulo E) Card_Responds_To_ReadRecord_DDA_Visa:
   [
   Card_Responded_To_GPO_Visa( ~PAN, <'DDA', furtherData>,
                               <TTQ, amount, country, currency, date, type, UN>, ATC, AC, CID, CTQ, IAD
   ),
   !Records_Visa( ~PAN, ~expDate, $CA, certBank, certCard ), Fr( ~nc ),
   !LtkCard( ~PAN, ~privkCard ), !SDADFormat( format, CID ),
   !IssuingBank( ~PAN, $Bank ), In( <'READ_RECORD', 'AFL'> )
   ]
  --[
  Running( ~PAN, ~nc,
           <'Card', 'Terminal', ~PAN, <'DDA', furtherData>, CTQ, 
            <TTQ, amount, country, currency, date, type, UN>, ATC, AC, IAD>
  ),
  Running( ~PAN, $Bank,
           <'Card', 'Bank', ~PAN, <'DDA', furtherData>, CTQ, 
            <TTQ, amount, country, currency, date, type, UN>, ATC, AC, IAD>
  )
  ]->
   [
   Out( <~PAN, ~expDate, $CA, certBank, certCard, ~nc, CTQ, 
         sign(<format, ATC, UN, amount, 'CHF', ~nc, CTQ, 'DDA', furtherData>,
              ~privkCard)
        >
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_Records_EMV_Visa:
   [
   Terminal_Sent_ReadRecord_Visa( $Terminal, PDOL, <'EMV', furtherData>,
                                  ~PAN, expDate, IAD, AC, 'ARQC', ATC, CTQ
   ),
   In( <~PAN, expDate> ), !IssuingBank( ~PAN, $Bank ),
   !CertBank( $Bank, <<'02', $Bank, pubkBank, $CA>, sign2> )
   ]
  -->
   [
   Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN, PDOL, <'EMV', furtherData>,
                                $CA, $Bank, pubkBank, 'Null', IAD, AC, 'ARQC', ATC, CTQ
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Receives_Records_DDA_Visa:
   [
   Terminal_Sent_ReadRecord_Visa( $Terminal,
                                  <TTQ, $amount, country, currency, date, type, ~UN>, <'DDA', furtherData>,
                                  ~PAN, expDate, IAD, AC, CID, ATC, CTQ
   ),
   In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
        <<'04', ~PAN, pubkCard, $Bank>, sign3>, nc, CTQ, SDAD>
   ),
   !IssuingCA( $Bank, $CA ), !SDADFormat( format, CID ),
   !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
   ]
  --[
  Eq( verify(sign1, <'01', $CA, pubkCA, $CA>, pubkCA), true ),
  Eq( verify(sign2, <'02', $Bank, pubkBank, $CA>, pubkCA), true ),
  Eq( verify(sign3, <'04', ~PAN, pubkCard, $Bank>, pubkBank), true ),
  Eq( verify(SDAD,
             <format, ATC, ~UN, $amount, 'CHF', nc, CTQ, 'DDA', furtherData>,
             pubkCard),
      true
  )
  ]->
   [
   Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN,
                                <TTQ, $amount, country, currency, date, type, ~UN>, <'DDA', furtherData>,
                                $CA, $Bank, pubkBank, nc, IAD, AC, CID, ATC, CTQ
   )
   ]

  /*
  rule (modulo AC) Terminal_Receives_Records_DDA_Visa:
     [
     Terminal_Sent_ReadRecord_Visa( $Terminal,
                                    <TTQ, $amount, country, currency, date, type, ~UN>, <'DDA', furtherData>,
                                    ~PAN, expDate, IAD, AC, CID, ATC, CTQ
     ),
     In( <~PAN, expDate, $CA, <<'02', $Bank, pubkBank, $CA>, sign2>, 
          <<'04', ~PAN, pubkCard, $Bank>, sign3>, nc, CTQ, SDAD>
     ),
     !IssuingCA( $Bank, $CA ), !SDADFormat( format, CID ),
     !CertCA( $CA, <<'01', $CA, pubkCA, $CA>, sign1> )
     ]
    --[ Eq( z, true ), Eq( z.1, true ), Eq( z.2, true ), Eq( z.3, true ) ]->
     [
     Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN,
                                  <TTQ, $amount, country, currency, date, type, ~UN>, <'DDA', furtherData>,
                                  $CA, $Bank, pubkBank, nc, IAD, AC, CID, ATC, CTQ
     )
     ]
    variants (modulo AC)
     1. $Bank = $Bank.62
        $CA   = $CA.63
        $amount
              = $amount.65
        ~PAN  = ~PAN.66
        ~UN   = ~UN.67
        ATC   = ATC.69
        CTQ   = CTQ.71
        SDAD  = SDAD.73
        format
              = format.79
        furtherData
              = furtherData.80
        nc    = nc.81
        pubkBank
              = pubkBank.82
        pubkCA
              = pubkCA.83
        pubkCard
              = pubkCard.84
        sign1 = sign1.85
        sign2 = sign2.86
        sign3 = sign3.87
        z     = verify(sign1.85, <'01', $CA.63, pubkCA.83, $CA.63>, pubkCA.83)
        z.1   = verify(sign2.86, <'02', $Bank.62, pubkBank.82, $CA.63>,
                       pubkCA.83)
        z.2   = verify(sign3.87, <'04', ~PAN.66, pubkCard.84, $Bank.62>,
                       pubkBank.82)
        z.3   = verify(SDAD.73,
                       <format.79, ATC.69, ~UN.67, $amount.65, 'CHF', nc.81, CTQ.71, 'DDA', 
                        furtherData.80>,
                       pubkCard.84)
    
     2. $Bank = $Bank.153
        $CA   = $CA.154
        $amount
              = $amount.156
        ~PAN  = ~PAN.157
        ~UN   = ~UN.158
        ATC   = ATC.160
        CTQ   = CTQ.162
        SDAD  = sign(<format.170, ATC.160, ~UN.158, $amount.156, 'CHF', nc.172, 
                      CTQ.162, 'DDA', furtherData.171>,
                     x.304)
        format
              = format.170
        furtherData
              = furtherData.171
        nc    = nc.172
        pubkBank
              = pubkBank.173
        pubkCA
              = pubkCA.174
        pubkCard
              = pk(x.304)
        sign1 = sign1.176
        sign2 = sign2.177
        sign3 = sign3.178
        z     = verify(sign1.176, <'01', $CA.154, pubkCA.174, $CA.154>,
                       pubkCA.174)
        z.1   = verify(sign2.177, <'02', $Bank.153, pubkBank.173, $CA.154>,
                       pubkCA.174)
        z.2   = verify(sign3.178, <'04', ~PAN.157, pk(x.304), $Bank.153>,
                       pubkBank.173)
        z.3   = true
    
     3. $Bank = $Bank.162
        $CA   = $CA.163
        $amount
              = $amount.165
        ~PAN  = ~PAN.166
        ~UN   = ~UN.167
        ATC   = ATC.169
        CTQ   = CTQ.171
        SDAD  = SDAD.173
        format
              = format.179
        furtherData
              = furtherData.180
        nc    = nc.181
        pubkBank
              = pubkBank.182
        pubkCA
              = pk(x.322)
        pubkCard
              = pubkCard.184
        sign1 = sign(<'01', $CA.163, pk(x.322), $CA.163>, x.322)
        sign2 = sign2.186
        sign3 = sign3.187
        z     = true
        z.1   = verify(sign2.186, <'02', $Bank.162, pubkBank.182, $CA.163>,
                       pk(x.322))
        z.2   = verify(sign3.187, <'04', ~PAN.166, pubkCard.184, $Bank.162>,
                       pubkBank.182)
        z.3   = verify(SDAD.173,
                       <format.179, ATC.169, ~UN.167, $amount.165, 'CHF', nc.181, CTQ.171, 
                        'DDA', furtherData.180>,
                       pubkCard.184)
    
     4. $Bank = $Bank.162
        $CA   = $CA.163
        $amount
              = $amount.165
        ~PAN  = ~PAN.166
        ~UN   = ~UN.167
        ATC   = ATC.169
        CTQ   = CTQ.171
        SDAD  = SDAD.173
        format
              = format.179
        furtherData
              = furtherData.180
        nc    = nc.181
        pubkBank
              = pk(x.322)
        pubkCA
              = pubkCA.183
        pubkCard
              = pubkCard.184
        sign1 = sign1.185
        sign2 = sign2.186
        sign3 = sign(<'04', ~PAN.166, pubkCard.184, $Bank.162>, x.322)
        z     = verify(sign1.185, <'01', $CA.163, pubkCA.183, $CA.163>,
                       pubkCA.183)
        z.1   = verify(sign2.186, <'02', $Bank.162, pk(x.322), $CA.163>,
                       pubkCA.183)
        z.2   = true
        z.3   = verify(SDAD.173,
                       <format.179, ATC.169, ~UN.167, $amount.165, 'CHF', nc.181, CTQ.171, 
                        'DDA', furtherData.180>,
                       pubkCard.184)
    
     5. $Bank = $Bank.162
        $CA   = $CA.163
        $amount
              = $amount.165
        ~PAN  = ~PAN.166
        ~UN   = ~UN.167
        ATC   = ATC.169
        CTQ   = CTQ.171
        SDAD  = sign(<format.179, ATC.169, ~UN.167, $amount.165, 'CHF', nc.181, 
                      CTQ.171, 'DDA', furtherData.180>,
                     x.315)
        format
              = format.179
        furtherData
              = furtherData.180
        nc    = nc.181
        pubkBank
              = pubkBank.182
        pubkCA
              = pk(x.322)
        pubkCard
              = pk(x.315)
        sign1 = sign(<'01', $CA.163, pk(x.322), $CA.163>, x.322)
        sign2 = sign2.186
        sign3 = sign3.187
        z     = true
        z.1   = verify(sign2.186, <'02', $Bank.162, pubkBank.182, $CA.163>,
                       pk(x.322))
        z.2   = verify(sign3.187, <'04', ~PAN.166, pk(x.315), $Bank.162>,
                       pubkBank.182)
        z.3   = true
    
     6. $Bank = $Bank.162
        $CA   = $CA.163
        $amount
              = $amount.165
        ~PAN  = ~PAN.166
        ~UN   = ~UN.167
        ATC   = ATC.169
        CTQ   = CTQ.171
        SDAD  = sign(<format.179, ATC.169, ~UN.167, $amount.165, 'CHF', nc.181, 
                      CTQ.171, 'DDA', furtherData.180>,
                     x.316)
        format
              = format.179
        furtherData
              = furtherData.180
        nc    = nc.181
        pubkBank
              = pk(x.322)
        pubkCA
              = pubkCA.183
        pubkCard
              = pk(x.316)
        sign1 = sign1.185
        sign2 = sign2.186
        sign3 = sign(<'04', ~PAN.166, pk(x.316), $Bank.162>, x.322)
        z     = verify(sign1.185, <'01', $CA.163, pubkCA.183, $CA.163>,
                       pubkCA.183)
        z.1   = verify(sign2.186, <'02', $Bank.162, pk(x.322), $CA.163>,
                       pubkCA.183)
        z.2   = true
        z.3   = true
    
     7. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = SDAD.174
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pubkBank.183
        pubkCA
              = pk(x.324)
        pubkCard
              = pubkCard.185
        sign1 = sign1.186
        sign2 = sign(<'02', $Bank.163, pubkBank.183, $CA.164>, x.324)
        sign3 = sign3.188
        z     = verify(sign1.186, <'01', $CA.164, pk(x.324), $CA.164>, pk(x.324))
        z.1   = true
        z.2   = verify(sign3.188, <'04', ~PAN.167, pubkCard.185, $Bank.163>,
                       pubkBank.183)
        z.3   = verify(SDAD.174,
                       <format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, CTQ.172, 
                        'DDA', furtherData.181>,
                       pubkCard.185)
    
     8. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = SDAD.174
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pubkBank.183
        pubkCA
              = pk(x.324)
        pubkCard
              = pubkCard.185
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign(<'02', $Bank.163, pubkBank.183, $CA.164>, x.324)
        sign3 = sign3.188
        z     = true
        z.1   = true
        z.2   = verify(sign3.188, <'04', ~PAN.167, pubkCard.185, $Bank.163>,
                       pubkBank.183)
        z.3   = verify(SDAD.174,
                       <format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, CTQ.172, 
                        'DDA', furtherData.181>,
                       pubkCard.185)
    
     9. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = SDAD.174
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pubkCard.185
        sign1 = sign1.186
        sign2 = sign(<'02', $Bank.163, pk(x.323), $CA.164>, x.324)
        sign3 = sign(<'04', ~PAN.167, pubkCard.185, $Bank.163>, x.323)
        z     = verify(sign1.186, <'01', $CA.164, pk(x.324), $CA.164>, pk(x.324))
        z.1   = true
        z.2   = true
        z.3   = verify(SDAD.174,
                       <format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, CTQ.172, 
                        'DDA', furtherData.181>,
                       pubkCard.185)
    
    10. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = SDAD.174
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pubkCard.185
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign2.187
        sign3 = sign(<'04', ~PAN.167, pubkCard.185, $Bank.163>, x.323)
        z     = true
        z.1   = verify(sign2.187, <'02', $Bank.163, pk(x.323), $CA.164>,
                       pk(x.324))
        z.2   = true
        z.3   = verify(SDAD.174,
                       <format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, CTQ.172, 
                        'DDA', furtherData.181>,
                       pubkCard.185)
    
    11. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = SDAD.174
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pubkCard.185
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign(<'02', $Bank.163, pk(x.323), $CA.164>, x.324)
        sign3 = sign(<'04', ~PAN.167, pubkCard.185, $Bank.163>, x.323)
        z     = true
        z.1   = true
        z.2   = true
        z.3   = verify(SDAD.174,
                       <format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, CTQ.172, 
                        'DDA', furtherData.181>,
                       pubkCard.185)
    
    12. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = sign(<format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, 
                      CTQ.172, 'DDA', furtherData.181>,
                     x.317)
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pubkBank.183
        pubkCA
              = pk(x.324)
        pubkCard
              = pk(x.317)
        sign1 = sign1.186
        sign2 = sign(<'02', $Bank.163, pubkBank.183, $CA.164>, x.324)
        sign3 = sign3.188
        z     = verify(sign1.186, <'01', $CA.164, pk(x.324), $CA.164>, pk(x.324))
        z.1   = true
        z.2   = verify(sign3.188, <'04', ~PAN.167, pk(x.317), $Bank.163>,
                       pubkBank.183)
        z.3   = true
    
    13. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = sign(<format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, 
                      CTQ.172, 'DDA', furtherData.181>,
                     x.317)
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pubkBank.183
        pubkCA
              = pk(x.324)
        pubkCard
              = pk(x.317)
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign(<'02', $Bank.163, pubkBank.183, $CA.164>, x.324)
        sign3 = sign3.188
        z     = true
        z.1   = true
        z.2   = verify(sign3.188, <'04', ~PAN.167, pk(x.317), $Bank.163>,
                       pubkBank.183)
        z.3   = true
    
    14. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = sign(<format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, 
                      CTQ.172, 'DDA', furtherData.181>,
                     x.317)
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pk(x.317)
        sign1 = sign1.186
        sign2 = sign(<'02', $Bank.163, pk(x.323), $CA.164>, x.324)
        sign3 = sign(<'04', ~PAN.167, pk(x.317), $Bank.163>, x.323)
        z     = verify(sign1.186, <'01', $CA.164, pk(x.324), $CA.164>, pk(x.324))
        z.1   = true
        z.2   = true
        z.3   = true
    
    15. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = sign(<format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, 
                      CTQ.172, 'DDA', furtherData.181>,
                     x.317)
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pk(x.317)
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign2.187
        sign3 = sign(<'04', ~PAN.167, pk(x.317), $Bank.163>, x.323)
        z     = true
        z.1   = verify(sign2.187, <'02', $Bank.163, pk(x.323), $CA.164>,
                       pk(x.324))
        z.2   = true
        z.3   = true
    
    16. $Bank = $Bank.163
        $CA   = $CA.164
        $amount
              = $amount.166
        ~PAN  = ~PAN.167
        ~UN   = ~UN.168
        ATC   = ATC.170
        CTQ   = CTQ.172
        SDAD  = sign(<format.180, ATC.170, ~UN.168, $amount.166, 'CHF', nc.182, 
                      CTQ.172, 'DDA', furtherData.181>,
                     x.317)
        format
              = format.180
        furtherData
              = furtherData.181
        nc    = nc.182
        pubkBank
              = pk(x.323)
        pubkCA
              = pk(x.324)
        pubkCard
              = pk(x.317)
        sign1 = sign(<'01', $CA.164, pk(x.324), $CA.164>, x.324)
        sign2 = sign(<'02', $Bank.163, pk(x.323), $CA.164>, x.324)
        sign3 = sign(<'04', ~PAN.167, pk(x.317), $Bank.163>, x.323)
        z     = true
        z.1   = true
        z.2   = true
        z.3   = true
  */

rule (modulo E) Terminal_Processes_CVM_NoPIN_Visa:
   [
   Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN,
                                <TTQ, $amount, country, currency, date, type, ~UN>, AIP, $CA, $Bank,
                                pubkBank, nc, IAD, AC, CID, ATC, 'NoPIN'
   ),
   !Value( $amount, 'Low' )
   ]
  -->
   [
   Terminal_Ready_To_Send_AC_Visa( $Terminal, ~PAN,
                                   <TTQ, $amount, country, currency, date, type, ~UN>, AIP, $CA, $Bank, nc,
                                   IAD, AC, CID, ATC, 'NoPIN', 'Null'
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Processes_CVM_CDCVM_Visa:
   [
   Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN, PDOL, AIP, $CA, $Bank,
                                pubkBank, nc, IAD, AC, 'ARQC', ATC, 'CDCVM'
   )
   ]
  -->
   [
   Terminal_Ready_To_Send_AC_Visa( $Terminal, ~PAN, PDOL, AIP, $CA, $Bank,
                                   nc, IAD, AC, 'ARQC', ATC, 'CDCVM', 'Null'
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Processes_CVM_OnlinePIN_Visa:
   [
   Terminal_Ready_For_CVM_Visa( $Terminal, ~PAN,
                                <TTQ, $amount, country, currency, date, type, ~UN>, AIP, $CA, $Bank,
                                pubkBank, nc, IAD, AC, 'ARQC', ATC, 'OnlinePIN'
   ),
   !Entered_PIN( ~PAN, PIN ), !Value( $amount, 'High' )
   ]
  -->
   [
   Terminal_Ready_To_Send_AC_Visa( $Terminal, ~PAN,
                                   <TTQ, $amount, country, currency, date, type, ~UN>, AIP, $CA, $Bank, nc,
                                   IAD, AC, 'ARQC', ATC, 'OnlinePIN', aenc(PIN, pubkBank)
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Terminal_Sends_GenerateAC_Visa:
   [
   Terminal_Ready_To_Send_AC_Visa( $Terminal, ~PAN, PDOL, AIP, $CA, $Bank,
                                   nc, IAD, AC, CID, ATC, CVM, encPIN
   ),
   Fr( ~channelID )
   ]
  --[
  Running( $Terminal, $Bank,
           <'Terminal', 'Bank', ~PAN, AIP, CVM, PDOL, ATC, AC, IAD>
  )
  ]->
   [
   Terminal_Received_AC_Visa( $Terminal, $Bank, $CA, nc, CID,
                              <~PAN, AIP, CVM, PDOL, ATC, AC, IAD>, ~channelID
   ),
   Send( $Terminal, $Bank, <~channelID, 'Visa', '1'>,
         <<~PAN, AIP, CVM, PDOL, ATC, AC, IAD>, encPIN>
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Receives_AC_Visa:
   [
   Recv( $Terminal, $Bank, <channelID, 'Visa', '1'>,
         <
          <~PAN, AIP, CVM, PDOL, ATC, MAC(f(~MK, ATC), PDOL, AIP, ATC, IAD), IAD>, 
          encPIN>
   ),
   !Shk( ~PAN, ~MK ), !IssuingBank( ~PAN, $Bank )
   ]
  --[ Once( <~PAN, ATC, 'Bank'> ) ]->
   [
   Bank_Checked_AC_Visa( $Bank, $Terminal,
                         <~PAN, AIP, CVM, PDOL, ATC, MAC(f(~MK, ATC), PDOL, AIP, ATC, IAD), IAD>,
                         encPIN, channelID,
                         DES3(f(~MK, ATC), (MAC(f(~MK, ATC), PDOL, AIP, ATC, IAD)âŠ•p8('ARC')))
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Receives_AC_Failed_Visa:
   [
   Recv( $Terminal, $Bank, <channelID, 'Visa', '1'>,
         <<~PAN, AIP, CVM, PDOL, ATC, AC, IAD>, encPIN>
   ),
   !Shk( ~PAN, ~MK )
   ]
  --[
  NEq( MAC(f(~MK, ATC), PDOL, AIP, ATC, IAD), AC ),
  BankDeclines( <~PAN, AIP, CVM, PDOL, ATC, AC, IAD> )
  ]->
   [ ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Processes_CVM_NotOnlinePIN_Visa:
   [
   Bank_Checked_AC_Visa( $Bank, $Terminal,
                         <~PAN, AIP, CVM, <TTQ, amount, country, currency, date, type, UN>, ATC, 
                          AC, IAD>,
                         'Null', channelID, ARPC
   )
   ]
  --[
  NEq( CVM, 'OnlinePIN' ),
  Running( $Bank, $Terminal,
           <'Bank', 'Terminal', ~PAN, AIP, CVM, 
            <TTQ, amount, country, currency, date, type, UN>, ATC, AC, IAD>
  )
  ]->
   [
   Bank_Commits_Visa( $Bank, $Terminal,
                      <~PAN, AIP, CVM, <TTQ, amount, country, currency, date, type, UN>, ATC, 
                       AC, IAD>,
                      channelID, ARPC
   )
   ]

  /* has exactly the trivial AC variant */

rule (modulo E) Bank_Processes_CVM_OnlinePIN_Visa:
   [
   Bank_Checked_AC_Visa( $Bank, $Terminal,
                         <~PAN, AIP, 'OnlinePIN', PDOL, ATC, AC, IAD>, aenc(~PIN, pk(~privkBank)),
                         channelID, ARPC
   ),
   !LtkBank( $Bank, ~privkBank ), !PIN( ~PAN, ~PIN )
   ]
  --[
  Running( $Bank, $Terminal,
           <'Bank', 'Terminal', ~PAN, AIP, 'OnlinePIN', PDOL, ATC, AC, IAD>
  )
  ]->
   [
   Bank_Commits_Visa( $Bank, $Terminal,
                      <~PAN, AIP, 'OnlinePIN', PDOL, ATC, AC, IAD>, channelID, ARPC
   )
   ]

  /* has exactly the trivial AC variant */

restriction equal:
  "âˆ€ a b #i. (Eq( a, b ) @ #i) â‡’ (a = b)"
  // safety formula

restriction not_equal:
  "âˆ€ a #i. (NEq( a, a ) @ #i) â‡’ (âŠ¥)"
  // safety formula

restriction once:
  "âˆ€ a #i #j. ((Once( a ) @ #i) âˆ§ (Once( a ) @ #j)) â‡’ (#i = #j)"
  // safety formula

restriction unique_role:
  "âˆ€ A r1 r2 #i #j.
    ((Role( A, r1 ) @ #i) âˆ§ (Role( A, r2 ) @ #j)) â‡’ (r1 = r2)"
  // safety formula

restriction compatibility:
  "(âˆ€ #i. (Compatible_CID_CVM( 'TC', 'OnlinePIN' ) @ #i) â‡’ (âŠ¥)) âˆ§
   (âˆ€ #i. (Compatible_CID_acType( 'TC', 'ARQC' ) @ #i) â‡’ (âŠ¥))"
  // safety formula

lemma executable:
  exists-trace
  "âˆƒ Bank PAN nc t #i #j #k #l.
    (((((((((#i < #j) âˆ§ (Running( PAN, nc, <'Card', 'Terminal', t> ) @ #i)) âˆ§
           (Commit( nc, PAN, <'Card', 'Terminal', t> ) @ #j)) âˆ§
          (#k < #l)) âˆ§
         (Running( PAN, Bank, <'Card', 'Bank', t> ) @ #k)) âˆ§
        (Commit( Bank, PAN, <'Card', 'Bank', t> ) @ #l)) âˆ§
       (âˆ€ #a #b. ((OneCard( ) @ #a) âˆ§ (OneCard( ) @ #b)) â‡’ (#a = #b))) âˆ§
      (âˆ€ #a #b. ((OneTerminal( ) @ #a) âˆ§ (OneTerminal( ) @ #b)) â‡’ (#a = #b))) âˆ§
     (âˆ€ A B r #a #b. ((Role( A, r ) @ #a) âˆ§ (Role( B, r ) @ #b)) â‡’ (A = B))) âˆ§
    (Â¬(âˆƒ A #a. Compromise( A ) @ #a))"
/*
guarded formula characterizing all satisfying traces:
"âˆƒ Bank PAN nc t #i #j #k #l.
  (Running( PAN, nc, <'Card', 'Terminal', t> ) @ #i) âˆ§
  (Commit( nc, PAN, <'Card', 'Terminal', t> ) @ #j) âˆ§
  (Running( PAN, Bank, <'Card', 'Bank', t> ) @ #k) âˆ§
  (Commit( Bank, PAN, <'Card', 'Bank', t> ) @ #l)
 âˆ§
  (#i < #j) âˆ§
  (#k < #l) âˆ§
  (âˆ€ #a #b. (OneCard( ) @ #a) âˆ§ (OneCard( ) @ #b) â‡’ #a = #b) âˆ§
  (âˆ€ #a #b. (OneTerminal( ) @ #a) âˆ§ (OneTerminal( ) @ #b) â‡’ #a = #b) âˆ§
  (âˆ€ A B r #a #b. (Role( A, r ) @ #a) âˆ§ (Role( B, r ) @ #b) â‡’ A = B) âˆ§
  (âˆ€ A #a. (Compromise( A ) @ #a) â‡’ âŠ¥)"
*/
simplify
solve( Running( PAN, nc, <'Card', 'Terminal', t> ) @ #i )
  case Card_Responds_To_GPO_EMV_Visa
  solve( !Shk( ~PAN, ~MK ) â–¶â‚ #i )
    case Create_Card
    solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚„ #i )
      case Create_Card
      by solve( !Visa( ~PAN ) â–¶â‚‚ #i )
    qed
  next
    case Create_Card_Visa
    solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚„ #i )
      case Create_Card_Visa
      solve( !Visa( ~PAN ) â–¶â‚‚ #i )
        case Create_Card_Visa
        solve( !ExpirationDate( ~PAN, ~expDate ) â–¶â‚ƒ #i )
          case Create_Card_Visa
          solve( !ATC( ATC ) â–¶â‚… #i )
            case Generate_ATC
            by solve( Commit( 'Null', ~PAN,
                              <'Card', 'Terminal', ~PAN, <'EMV', $furtherData>, CVM, 
                               <<acType, CVM>, amount, country, currency, date, type, UN>, ~ATC, 
                               MAC(f(~MK, ~ATC),
                                   <<acType, CVM>, amount, country, currency, date, type, UN>,
                                   <'EMV', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                               'IAD', 'ARQC'>
                      ) @ #j )
          qed
        qed
      qed
    qed
  qed
next
  case Card_Responds_To_GenerateAC_CDA
  solve( !Shk( ~PAN, ~MK ) â–¶â‚ƒ #i )
    case Create_Card
    solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚„ #i )
      case Create_Card
      solve( Card_Ready_For_Transaction( ~PAN,
                                         <amount, country, currency, date, type, UN>, ATC
             ) â–¶â‚€ #i )
        case Card_Responds_To_InternalAuthenticate
        solve( !LtkCard( ~PAN, ~privkCard ) â–¶â‚ #i )
          case Set_Records_NotSDA
          by solve( !AIP( ~PAN, <'CDA', furtherData> ) â–¶â‚‚ #i )
        qed
      next
        case Card_Responds_To_ReadRecord_NotDDA_case_1
        by solve( !LtkCard( ~PAN, ~privkCard ) â–¶â‚ #i )
      next
        case Card_Responds_To_ReadRecord_NotDDA_case_2
        solve( !LtkCard( ~PAN, ~privkCard ) â–¶â‚ #i )
          case Set_Records_NotSDA
          solve( !AIP( ~PAN, <'CDA', furtherData> ) â–¶â‚‚ #i )
            case Create_Card
            by solve( Commit( ~nc, ~PAN,
                              <'Card', 'Terminal', ~PAN, <'CDA', $furtherData>, CVM, 
                               <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>, 
                               ~ATC, 
                               MAC(f(~MK, ~ATC),
                                   <<amount, country, currency, date, type, UN>, 'TVR', CVM, 'HHMMSS'>,
                                   <'CDA', $furtherData>, ~ATC, <'IAD', CID>), 
                               'IAD', CID>
                      ) @ #j )
          qed
        qed
      qed
    qed
  next
    case Create_Card_Visa
    solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚„ #i )
      case Create_Card_Visa
      by solve( Card_Ready_For_Transaction( ~PAN,
                                            <amount, country, currency, date, type, UN>, ATC
                ) â–¶â‚€ #i )
    qed
  qed
next
  case Card_Responds_To_GenerateAC_NoCDA
  solve( !AIP( ~PAN, AIP ) â–¶â‚ #i )
    case Create_Card
    solve( !Shk( ~PAN, ~MK ) â–¶â‚‚ #i )
      case Create_Card
      solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚ƒ #i )
        case Create_Card
        solve( Card_Ready_For_Transaction( ~PAN, PDOL, ATC ) â–¶â‚€ #i )
          case Card_Responds_To_InternalAuthenticate
          solve( Commit( 'Null', ~PAN,
                         <'Card', 'Terminal', ~PAN, <'DDA', $furtherData>, CVM, 
                          <PDOL, 'TVR', CVM, 'HHMMSS'>, ~ATC, 
                          MAC(f(~MK, ~ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, <'DDA', $furtherData>,
                              ~ATC, <'IAD', CID>), 
                          'IAD', CID>
                 ) @ #j )
            case Terminal_Commits_ARQC
            solve( !KU( ~UN ) @ #vk.32 )
              case Card_Responds_To_GenerateAC_NoCDA
              by contradiction /* cyclic */
            next
              case Card_Responds_To_InternalAuthenticate
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_1
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_2
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_3
              by contradiction /* cyclic */
            next
              case Compromise_Bank
              by contradiction /* from formulas */
            next
              case Compromise_Bank_Card_ShK
              by contradiction /* from formulas */
            next
              case Compromise_CA
              by contradiction /* from formulas */
            next
              case Compromise_Card_case_1
              by contradiction /* from formulas */
            next
              case Compromise_Card_case_2
              by contradiction /* from formulas */
            next
              case Generate_ATC
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_High_Visa
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_Low_Visa
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_case_1
              solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                           <~PAN, <'DDA', $furtherData>, CVM, 
                                            <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                             'HHMMSS'>, 
                                            ~ATC, 
                                            MAC(f(~MK, ~ATC),
                                                <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                 'HHMMSS'>,
                                                <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                            'IAD', CID>,
                                           'NoPIN', ~channelID
                     ) â–¶â‚€ #j )
                case Terminal_Receives_AC_NoCDA
                solve( !KU( ~ATC ) @ #vk.41 )
                  case Card_Responds_To_GenerateAC_NoCDA
                  solve( !KU( ~PAN ) @ #vk.51 )
                    case Card_Responds_To_ReadRecord_DDA_case_1
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Card_Responds_To_ReadRecord_DDA_case_2
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Compromise_Card
                    by contradiction /* from formulas */
                  qed
                next
                  case Generate_ATC
                  solve( !KU( ~PAN ) @ #vk.51 )
                    case Card_Responds_To_ReadRecord_DDA_case_1
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Card_Responds_To_ReadRecord_DDA_case_2
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Compromise_Card
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            next
              case Terminal_Sends_GPO_case_2
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_InternalAuthenticate_case_1
              solve( !KU( ~PAN.1 ) @ #vk.36 )
                case Card_Responds_To_GenerateAC_NoCDA
                by contradiction /* cyclic */
              next
                case Card_Responds_To_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_3
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case Terminal_Sends_InternalAuthenticate_case_2
              solve( !KU( ~PAN.1 ) @ #vk.36 )
                case Card_Responds_To_GenerateAC_NoCDA
                by contradiction /* cyclic */
              next
                case Card_Responds_To_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_3
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case fresh
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'ARQC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            qed
          next
            case Terminal_Commits_TC
            solve( !KU( ~UN ) @ #vk.32 )
              case Card_Responds_To_GenerateAC_NoCDA
              by contradiction /* cyclic */
            next
              case Card_Responds_To_InternalAuthenticate
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_1
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_2
              by contradiction /* cyclic */
            next
              case Card_Responds_To_ReadRecord_DDA_case_3
              by contradiction /* cyclic */
            next
              case Compromise_Bank
              by contradiction /* from formulas */
            next
              case Compromise_Bank_Card_ShK
              by contradiction /* from formulas */
            next
              case Compromise_CA
              by contradiction /* from formulas */
            next
              case Compromise_Card_case_1
              by contradiction /* from formulas */
            next
              case Compromise_Card_case_2
              by contradiction /* from formulas */
            next
              case Generate_ATC
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_High_Visa
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_Low_Visa
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_GPO_case_1
              solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                           <~PAN, <'DDA', $furtherData>, CVM, 
                                            <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                             'HHMMSS'>, 
                                            ~ATC, 
                                            MAC(f(~MK, ~ATC),
                                                <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                 'HHMMSS'>,
                                                <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                            'IAD', CID>,
                                           'NoPIN', ~channelID
                     ) â–¶â‚€ #j )
                case Terminal_Receives_AC_NoCDA
                solve( !KU( ~ATC ) @ #vk.41 )
                  case Card_Responds_To_GenerateAC_NoCDA
                  solve( !KU( ~PAN ) @ #vk.51 )
                    case Card_Responds_To_ReadRecord_DDA_case_1
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Card_Responds_To_ReadRecord_DDA_case_2
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Compromise_Card
                    by contradiction /* from formulas */
                  qed
                next
                  case Generate_ATC
                  solve( !KU( ~PAN ) @ #vk.51 )
                    case Card_Responds_To_ReadRecord_DDA_case_1
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Card_Responds_To_ReadRecord_DDA_case_2
                    by solve( !Value( $amount, 'High' ) â–¶â‚ #j )
                  next
                    case Compromise_Card
                    by contradiction /* from formulas */
                  qed
                qed
              qed
            next
              case Terminal_Sends_GPO_case_2
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            next
              case Terminal_Sends_InternalAuthenticate_case_1
              solve( !KU( ~PAN.1 ) @ #vk.36 )
                case Card_Responds_To_GenerateAC_NoCDA
                by contradiction /* cyclic */
              next
                case Card_Responds_To_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_3
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case Terminal_Sends_InternalAuthenticate_case_2
              solve( !KU( ~PAN.1 ) @ #vk.36 )
                case Card_Responds_To_GenerateAC_NoCDA
                by contradiction /* cyclic */
              next
                case Card_Responds_To_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_case_3
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate
                by contradiction /* cyclic */
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                                <~PAN, <'DDA', $furtherData>, CVM, 
                                                 <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                  'HHMMSS'>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                      CVM, 'HHMMSS'>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                                 'IAD', CID>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case fresh
              by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA, 'Null', 'TC',
                                              <~PAN, <'DDA', $furtherData>, CVM, 
                                               <<$amount, country, currency, date, type, ~UN>, 'TVR', CVM, 
                                                'HHMMSS'>, 
                                               ~ATC, 
                                               MAC(f(~MK, ~ATC),
                                                   <<$amount, country, currency, date, type, ~UN>, 'TVR', 
                                                    CVM, 'HHMMSS'>,
                                                   <'DDA', $furtherData>, ~ATC, <'IAD', CID>), 
                                               'IAD', CID>,
                                              'NoPIN', ~channelID
                        ) â–¶â‚€ #j )
            qed
          qed
        next
          case Card_Responds_To_ReadRecord_NotDDA_case_1
          by solve( Commit( 'Null', ~PAN,
                            <'Card', 'Terminal', ~PAN, <'SDA', $furtherData>, CVM, 
                             <PDOL, 'TVR', CVM, 'HHMMSS'>, ~ATC, 
                             MAC(f(~MK, ~ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, <'SDA', $furtherData>,
                                 ~ATC, <'IAD', CID>), 
                             'IAD', CID>
                    ) @ #j )
        next
          case Card_Responds_To_ReadRecord_NotDDA_case_2
          solve( Commit( 'Null', ~PAN,
                         <'Card', 'Terminal', ~PAN, <auth, $furtherData>, CVM, 
                          <PDOL, 'TVR', CVM, 'HHMMSS'>, ~ATC, 
                          MAC(f(~MK, ~ATC), <PDOL, 'TVR', CVM, 'HHMMSS'>, <auth, $furtherData>,
                              ~ATC, <'IAD', CID>), 
                          'IAD', CID>
                 ) @ #j )
            case Terminal_Commits_ARQC
            by contradiction /* from formulas */
          next
            case Terminal_Commits_TC
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
next
  case Card_Responds_To_ReadRecord_DDA_Visa
  solve( !IssuingBank( ~PAN, $Bank ) â–¶â‚… #i )
    case Create_Card
    by solve( Card_Responded_To_GPO_Visa( ~PAN, <'DDA', furtherData>,
                                          <TTQ, amount, country, currency, date, type, UN>, ATC, AC, CID, CTQ,
                                          IAD
              ) â–¶â‚€ #i )
  next
    case Create_Card_Visa
    solve( Card_Responded_To_GPO_Visa( ~PAN, <'DDA', furtherData>,
                                       <TTQ, amount, country, currency, date, type, UN>, ATC, AC, CID, CTQ,
                                       IAD
           ) â–¶â‚€ #i )
      case Card_Responds_To_GPO_DDA_Visa
      solve( !Records_Visa( ~PAN, ~expDate, $CA, certBank, certCard ) â–¶â‚ #i )
        case Create_Card_Visa
        solve( !LtkCard( ~PAN, ~privkCard.1 ) â–¶â‚ƒ #i )
          case Create_Card_Visa
          solve( !SDADFormat( format, CID ) â–¶â‚„ #i )
            case Generate_SDAD_Format_Visa_case_1
            solve( Commit( ~nc, ~PAN,
                           <'Card', 'Terminal', ~PAN, <'DDA', $furtherData>, CTQ, 
                            <<'TC', CTQ>, amount, country, currency, date, type, UN>, ~ATC, 
                            MAC(f(~MK, ~ATC),
                                <<'TC', CTQ>, amount, country, currency, date, type, UN>,
                                <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                            'IAD', 'TC'>
                   ) @ #j )
              case Terminal_Commits_ARQC
              solve( !KU( ~UN ) @ #vk.27 )
                case Card_Responds_To_GPO_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_High_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_Low_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_1
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_2
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate_case_1
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case Terminal_Sends_InternalAuthenticate_case_2
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case Terminal_Commits_TC
              solve( !KU( ~UN ) @ #vk.27 )
                case Card_Responds_To_GPO_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_High_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_Low_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_1
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_2
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate_case_1
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case Terminal_Sends_InternalAuthenticate_case_2
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'TC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'TC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                   'IAD', 'TC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'TC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'TC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'TC'>), 
                                                 'IAD', 'TC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            qed
          next
            case Generate_SDAD_Format_Visa_case_2
            solve( Commit( ~nc, ~PAN,
                           <'Card', 'Terminal', ~PAN, <'DDA', $furtherData>, CTQ, 
                            <<'ARQC', CTQ>, amount, country, currency, date, type, UN>, ~ATC, 
                            MAC(f(~MK, ~ATC),
                                <<'ARQC', CTQ>, amount, country, currency, date, type, UN>,
                                <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                            'IAD', 'ARQC'>
                   ) @ #j )
              case Terminal_Commits_ARQC
              solve( !KU( ~UN ) @ #vk.27 )
                case Card_Responds_To_GPO_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_High_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_Low_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_1
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_2
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate_case_1
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case Terminal_Sends_InternalAuthenticate_case_2
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'ARQC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            next
              case Terminal_Commits_TC
              solve( !KU( ~UN ) @ #vk.27 )
                case Card_Responds_To_GPO_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_GPO_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                by contradiction /* cyclic */
              next
                case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                by contradiction /* cyclic */
              next
                case Compromise_Bank
                by contradiction /* from formulas */
              next
                case Compromise_Bank_Card_ShK
                by contradiction /* from formulas */
              next
                case Compromise_CA
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_1
                by contradiction /* from formulas */
              next
                case Compromise_Card_case_2
                by contradiction /* from formulas */
              next
                case Generate_ATC
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_High_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_Low_Visa
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_1
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_GPO_case_2
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              next
                case Terminal_Sends_InternalAuthenticate_case_1
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case Terminal_Sends_InternalAuthenticate_case_2
                solve( !KU( ~PAN.1 ) @ #vk.30 )
                  case Card_Responds_To_GPO_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_GPO_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_1
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_2
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_3
                  by contradiction /* cyclic */
                next
                  case Card_Responds_To_ReadRecord_DDA_Visa_case_4
                  by contradiction /* cyclic */
                next
                  case Compromise_Bank
                  by contradiction /* from formulas */
                next
                  case Compromise_Bank_Card_ShK
                  by contradiction /* from formulas */
                next
                  case Compromise_CA
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_1
                  by contradiction /* from formulas */
                next
                  case Compromise_Card_case_2
                  by contradiction /* from formulas */
                next
                  case Generate_ATC
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                next
                  case Terminal_Sends_InternalAuthenticate
                  by contradiction /* cyclic */
                next
                  case fresh
                  by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                  <~PAN, <'DDA', $furtherData>, 
                                                   <country, currency, date, type, ~UN>, 
                                                   <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                    country.1, currency.1, date.1, type.1, UN.1>, 
                                                   ~ATC, 
                                                   MAC(f(~MK, ~ATC),
                                                       <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                        country.1, currency.1, date.1, type.1, UN.1>,
                                                       <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                   'IAD', 'ARQC'>,
                                                  'NoPIN', ~channelID
                            ) â–¶â‚€ #j )
                qed
              next
                case fresh
                by solve( Terminal_Received_AC( $Terminal, $Bank.1, $CA.1, ~nc, 'TC',
                                                <~PAN, <'DDA', $furtherData>, 
                                                 <country, currency, date, type, ~UN>, 
                                                 <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                  country.1, currency.1, date.1, type.1, UN.1>, 
                                                 ~ATC, 
                                                 MAC(f(~MK, ~ATC),
                                                     <<'ARQC', country, currency, date, type, ~UN>, amount, 
                                                      country.1, currency.1, date.1, type.1, UN.1>,
                                                     <'DDA', $furtherData>, ~ATC, <'IAD', 'ARQC'>), 
                                                 'IAD', 'ARQC'>,
                                                'NoPIN', ~channelID
                          ) â–¶â‚€ #j )
              qed
            qed
          qed
        qed
      qed
    qed
  qed
qed

lemma secrecy_MK:
  all-traces
  "âˆ€ MK #i.
    (SecretMK( MK ) @ #i) â‡’
    ((Â¬(âˆƒ #j. !KU( MK ) @ #j)) âˆ¨
     (âˆƒ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k)))"
/*
guarded formula characterizing all counter-examples:
"âˆƒ MK #i.
  (SecretMK( MK ) @ #i)
 âˆ§
  (âˆƒ #j. (!KU( MK ) @ #j)) âˆ§
  (âˆ€ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k) â‡’ âŠ¥)"
*/
simplify
solve( SecretMK( MK ) @ #i )
  case Create_Card
  solve( !LtkBank( $Bank, ~privkBank ) â–¶â‚ƒ #i )
    case Create_Bank
    solve( !CertBank( $Bank, certBank ) â–¶â‚„ #i )
      case Create_Bank
      solve( !IssuingCA( $Bank, $CA.1 ) â–¶â‚… #i )
        case Create_Bank
        solve( !KU( ~MK ) @ #j )
          case Compromise_Bank_Card_ShK
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case Create_Card_Visa
  solve( !LtkBank( $Bank, ~privkBank ) â–¶â‚„ #i )
    case Create_Bank
    solve( !CertBank( $Bank, certBank ) â–¶â‚… #i )
      case Create_Bank
      solve( !IssuingCA( $Bank, $CA.1 ) â–¶â‚† #i )
        case Create_Bank
        solve( !KU( ~MK ) @ #j )
          case Compromise_Bank_Card_ShK
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
qed

lemma secrecy_privkCard:
  all-traces
  "âˆ€ privkCard #i.
    (SecretPrivkCard( privkCard ) @ #i) â‡’
    ((Â¬(âˆƒ #j. !KU( privkCard ) @ #j)) âˆ¨
     (âˆƒ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k)))"
/*
guarded formula characterizing all counter-examples:
"âˆƒ privkCard #i.
  (SecretPrivkCard( privkCard ) @ #i)
 âˆ§
  (âˆƒ #j. (!KU( privkCard ) @ #j)) âˆ§
  (âˆ€ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k) â‡’ âŠ¥)"
*/
simplify
solve( SecretPrivkCard( privkCard ) @ #i )
  case Create_Card_Visa
  solve( !LtkBank( $Bank, ~privkBank ) â–¶â‚„ #i )
    case Create_Bank
    solve( !CertBank( $Bank, certBank ) â–¶â‚… #i )
      case Create_Bank
      solve( !IssuingCA( $Bank, $CA.1 ) â–¶â‚† #i )
        case Create_Bank
        solve( !KU( ~privkCard ) @ #j )
          case Compromise_Card
          by contradiction /* from formulas */
        qed
      qed
    qed
  qed
next
  case Set_Records_NotSDA
  solve( Set_Records( ~PAN, ~expDate, $CA, certBank, SSAD, CVM ) â–¶â‚€ #i )
    case Create_Card
    solve( !AIP( ~PAN, AIP ) â–¶â‚‚ #i )
      case Create_Card
      solve( !IssuingBank( ~PAN, $Bank.1 ) â–¶â‚ƒ #i )
        case Create_Card
        solve( !LtkBank( $Bank, ~privkBank.1 ) â–¶â‚„ #i )
          case Create_Bank
          solve( !KU( ~privkCard ) @ #j )
            case Compromise_Card
            by contradiction /* from formulas */
          qed
        qed
      qed
    qed
  qed
qed

lemma secrecy_PAN:
  all-traces
  "âˆ€ PAN #i.
    (SecretPAN( PAN ) @ #i) â‡’
    ((Â¬(âˆƒ #j. !KU( PAN ) @ #j)) âˆ¨
     (âˆƒ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k)))"
/*
guarded formula characterizing all counter-examples:
"âˆƒ PAN #i.
  (SecretPAN( PAN ) @ #i)
 âˆ§
  (âˆƒ #j. (!KU( PAN ) @ #j)) âˆ§
  (âˆ€ A #k. (Honest( A ) @ #i) âˆ§ (Compromise( A ) @ #k) â‡’ âŠ¥)"
*/
simplify
solve( SecretPAN( PAN ) @ #i )
  case Create_Card
  solve( !LtkBank( $Bank, ~privkBank ) â–¶â‚ƒ #i )
    case Create_Bank
    solve( !CertBank( $Bank, certBank ) â–¶â‚„ #i )
      case Create_Bank
      solve( !IssuingCA( $Bank, $CA.1 ) â–¶â‚… #i )
        case Create_Bank
        solve( !KU( ~PAN ) @ #j )
          case Card_Responds_To_ReadRecord_DDA_case_1
          SOLVED // trace found
        qed
      qed
    qed
  qed
qed

/* All well-formedness checks were successful. */

end

==============================================================================
summary of summaries:

analyzed: models-n-proofs/contactless/Mastercard_DDA_NoPIN_High.spthy

  executable (exists-trace): falsified - no trace found (350 steps)
  secrecy_MK (all-traces): verified (12 steps)
  secrecy_privkCard (all-traces): verified (13 steps)
  secrecy_PAN (all-traces): falsified - found trace (7 steps)

==============================================================================

real	1m2.030s
user	6m40.230s
sys	0m27.459s
